{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <form class="row g-2 align-items-end" method="get">
        <div class="col-12 col-md-2">
          <label class="form-label">Market</label>
          <select name="market" class="form-select">
            <option value="both" {% if market == 'both' %}selected{% endif %}>Both</option>
            <option value="spot" {% if market == 'spot' %}selected{% endif %}>Spot</option>
            <option value="futures" {% if market == 'futures' %}selected{% endif %}>Futures</option>
          </select>
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label">Status</label>
          <select name="status" class="form-select">
            <option value="" {% if not status %}selected{% endif %}>Any</option>
            <option value="OPEN" {% if status == 'OPEN' %}selected{% endif %}>Open</option>
            <option value="POSITION" {% if status == 'POSITION' %}selected{% endif %}>Position</option>
            <option value="CLOSED" {% if status == 'CLOSED' %}selected{% endif %}>Closed</option>
            <option value="CANCELLED" {% if status == 'CANCELLED' %}selected{% endif %}>Cancelled</option>
            <option value="FAILED" {% if status == 'FAILED' %}selected{% endif %}>Failed</option>
          </select>
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label">Symbol</label>
          <input name="symbol" value="{{ symbol }}" class="form-control" placeholder="e.g. BTCUSDT"/>
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label">From</label>
          <input name="from" value="{{ date_from }}" class="form-control" type="datetime-local"/>
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label">To</label>
          <input name="to" value="{{ date_to }}" class="form-control" type="datetime-local"/>
        </div>
        <div class="col-12 col-md-2">
          <button class="btn btn-primary w-100">Filter</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover table-sm align-middle">
          <thead>
            <tr>
              <th>Time</th>
              <th>Market</th>
              <th>Symbol</th>
              <th>Dir</th>
              <th>Status</th>
              <th>Qty</th>
              <th>Entry</th>
              <th>PnL</th>
              <th>PnL %</th>
              <th>TP</th>
              <th>SL</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for r in records %}
            <tr>
              <td class="text-nowrap">{{ r.created_at|date:"Y-m-d H:i" }}</td>
              <td><span class="badge bg-dark">{{ r.market }}</span></td>
              <td>{{ r.symbol }}</td>
              <td>{{ r.direction }}</td>
              <td>
                {% if r.status == 'CLOSED' %}<span class="badge bg-success">{{ r.status }}</span>
                {% elif r.status == 'POSITION' %}<span class="badge bg-warning text-dark">{{ r.status }}</span>
                {% elif r.status == 'OPEN' %}<span class="badge bg-info text-dark">{{ r.status }}</span>
                {% else %}<span class="badge bg-secondary">{{ r.status }}</span>
                {% endif %}
              </td>
              <td>{{ r.quantity|floatformat:4 }}</td>
              <td>{{ r.entry_price|default_if_none:"-"|floatformat:4 }}</td>
              <td class="{% if r.pnl >= 0 %}text-success{% else %}text-danger{% endif %}">{{ r.pnl|floatformat:2 }}</td>
              <td class="{% if r.pnl_pct >= 0 %}text-success{% else %}text-danger{% endif %}">{{ r.pnl_pct|floatformat:2 }}%</td>
              <td>
                {% if r.market == 'Futures' %}
                  {% if r.tp_count and r.tp_count > 0 %}
                    <span class="text-nowrap">{{ r.tp_closed }}/{{ r.tp_count }} TPs</span>
                  {% else %}-{% endif %}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if r.sl_price and r.sl_price > 0 %}
                  {{ r.sl_price|floatformat:4 }}
                {% else %}
                  -
                {% endif %}
                {% if r.sl_status %}
                  {% if r.sl_status == 'POSITION' %}
                    <span class="badge bg-info text-dark ms-1">Open</span>
                  {% elif r.sl_status == 'CLOSED' %}
                    <span class="badge bg-success ms-1">Closed</span>
                  {% elif r.sl_status == 'CANCELLED' %}
                    <span class="badge bg-secondary ms-1">Cancelled</span>
                  {% elif r.sl_status == 'FAILED' %}
                    <span class="badge bg-danger ms-1">Failed</span>
                  {% endif %}
                {% endif %}
              </td>
              <td>
                {% if r.market == 'Futures' and r.status == 'POSITION' %}
                  <!-- Manage TPs button -->
                  <button class="btn btn-sm btn-outline-secondary me-1" title="Manage TPs"
                          data-bs-toggle="modal" data-bs-target="#tpsModal"
                          data-order-id="{{ r.id }}" data-symbol="{{ r.symbol }}"
                          data-tps="{{ r.tps_json|urlencode }}">
                    <i class="bi bi-list-check"></i>
                  </button>
                  <!-- SL button -->
                  <button class="btn btn-sm btn-outline-danger me-1" title="{% if r.sl_price and r.sl_price > 0 %}Edit SL{% else %}Add SL{% endif %}"
                          data-bs-toggle="modal" data-bs-target="#slModal"
                          data-order-id="{{ r.id }}" data-symbol="{{ r.symbol }}" data-current="{{ r.sl_price|default_if_none:'' }}" data-market="{{ r.market }}">
                    {% if r.sl_price and r.sl_price > 0 %}<i class="bi bi-pencil-square"></i>{% else %}<i class="bi bi-plus-circle"></i>{% endif %}
                  </button>
                  <!-- Close button -->
                  <form method="post" action="{% url 'trading:close_futures_order' %}" style="display:inline" onsubmit="return confirm('Close this position?')">
                    {% csrf_token %}
                    <input type="hidden" name="order_id" value="{{ r.id }}" />
                    <button type="submit" class="btn btn-sm btn-outline-dark" title="Close position">
                      <i class="bi bi-x-circle"></i>
                    </button>
                  </form>
                  <!-- Refresh button -->
                  <form method="post" action="{% url 'trading:refresh_order' %}" style="display:inline" class="refresh-form">
                    {% csrf_token %}
                    <input type="hidden" name="order_id" value="{{ r.id }}" />
                    <input type="hidden" name="market" value="{{ r.market }}" />
                    <button type="submit" class="btn btn-sm btn-outline-success ms-1 refresh-btn" title="Refresh status">
                      <i class="bi bi-arrow-repeat refresh-icon"></i>
                    </button>
                  </form>
                  <!-- Toggle ignore opposite signals -->
                  <form method="post" action="{% url 'trading:toggle_ignore_signal' %}" style="display:inline">
                    {% csrf_token %}
                    <input type="hidden" name="order_id" value="{{ r.id }}" />
                    <input type="hidden" name="market" value="{{ r.market }}" />
                    <button type="submit" class="btn btn-sm {% if r.ignore %}btn-warning{% else %}btn-outline-secondary{% endif %} ms-1" title="{% if r.ignore %}Ignore opposite signals: ON{% else %}Ignore opposite signals: OFF{% endif %}">
                      {% if r.ignore %}<i class="bi bi-slash-circle-fill"></i>{% else %}<i class="bi bi-slash-circle"></i>{% endif %}
                    </button>
                  </form>
                {% elif r.market == 'Spot' and r.status == 'POSITION' %}
                  <!-- Close button for Spot -->
                  <!-- SL button for Spot -->
                  <button class="btn btn-sm btn-outline-danger me-1" title="{% if r.sl_price and r.sl_price > 0 %}Edit SL{% else %}Add SL{% endif %}"
                          data-bs-toggle="modal" data-bs-target="#slModal"
                          data-order-id="{{ r.id }}" data-symbol="{{ r.symbol }}" data-current="{{ r.sl_price|default_if_none:'' }}" data-market="{{ r.market }}">
                    {% if r.sl_price and r.sl_price > 0 %}<i class="bi bi-pencil-square"></i>{% else %}<i class="bi bi-plus-circle"></i>{% endif %}
                  </button>
                  <form method="post" action="{% url 'trading:close_spot_order' %}" style="display:inline" onsubmit="return confirm('Close this position?')">
                    {% csrf_token %}
                    <input type="hidden" name="order_id" value="{{ r.id }}" />
                    <button type="submit" class="btn btn-sm btn-outline-dark" title="Close position">
                      <i class="bi bi-x-circle"></i>
                    </button>
                  </form>
                  <!-- Refresh button for Spot -->
                  <form method="post" action="{% url 'trading:refresh_order' %}" style="display:inline" class="refresh-form">
                    {% csrf_token %}
                    <input type="hidden" name="order_id" value="{{ r.id }}" />
                    <input type="hidden" name="market" value="{{ r.market }}" />
                    <button type="submit" class="btn btn-sm btn-outline-success ms-1 refresh-btn" title="Refresh status">
                      <i class="bi bi-arrow-repeat refresh-icon"></i>
                    </button>
                  </form>
                  <!-- Toggle ignore opposite signals for Spot -->
                  <form method="post" action="{% url 'trading:toggle_ignore_signal' %}" style="display:inline">
                    {% csrf_token %}
                    <input type="hidden" name="order_id" value="{{ r.id }}" />
                    <input type="hidden" name="market" value="{{ r.market }}" />
                    <button type="submit" class="btn btn-sm {% if r.ignore %}btn-warning{% else %}btn-outline-secondary{% endif %} ms-1" title="{% if r.ignore %}Ignore opposite signals: ON{% else %}Ignore opposite signals: OFF{% endif %}">
                      {% if r.ignore %}<i class="bi bi-slash-circle-fill"></i>{% else %}<i class="bi bi-slash-circle"></i>{% endif %}
                    </button>
                  </form>
                {% else %}-{% endif %}
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="10" class="text-center text-muted">No records</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- TP Modal -->
<div class="modal fade" id="tpsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" action="{% url 'trading:update_futures_multi_tp' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Manage Take Profits <span id="tpsModalSymbol" class="text-muted"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="order_id" id="tpsModalOrderId" />
          <div id="tpRows">
            <div class="row g-2 align-items-end tp-row">
              <div class="col-6">
                <label class="form-label">TP Price</label>
                <input name="tp_prices[]" class="form-control" placeholder="e.g. 70500" />
              </div>
              <div class="col-4">
                <label class="form-label">% of Position</label>
                <input name="tp_percents[]" class="form-control" placeholder="e.g. 10" />
              </div>
              <div class="col-2">
                <button type="button" class="btn btn-outline-danger remove-row w-100">Remove</button>
              </div>
            </div>
          </div>
          <div class="mt-2">
            <button type="button" class="btn btn-outline-secondary" id="addTpRow">Add TP</button>
            <span class="ms-2 text-muted small" id="tpTotalPct">Total: 0%</span>
          </div>
          <div class="text-muted small mt-2">Ensure total percent does not exceed 100%. Values validated server-side.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="tpModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'trading:update_futures_tp_sl' %}">
        {% csrf_token %}
        <input type="hidden" name="mode" value="tp" />
        <div class="modal-header">
          <h5 class="modal-title">Set Take Profit <span id="tpModalSymbol" class="text-muted"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="order_id" id="tpModalOrderId" />
          <div class="mb-3">
            <label class="form-label">Take Profit price</label>
            <input name="tp" id="tpModalValue" class="form-control" placeholder="e.g. 70500" />
            <div class="form-text">Leave empty to remove TP.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- SL Modal -->
<div class="modal fade" id="slModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'trading:update_futures_tp_sl' %}">
        {% csrf_token %}
        <input type="hidden" name="mode" value="sl" />
        <div class="modal-header">
          <h5 class="modal-title">Set Stop Loss <span id="slModalSymbol" class="text-muted"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="order_id" id="slModalOrderId" />
          <div class="mb-3">
            <label class="form-label">Stop Loss price</label>
            <input name="sl" id="slModalValue" class="form-control" placeholder="e.g. 65500" />
            <div class="form-text">Leave empty to remove SL.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const tpModal = document.getElementById('tpModal');
  if (tpModal) {
    tpModal.addEventListener('show.bs.modal', event => {
      const btn = event.relatedTarget;
      const orderId = btn.getAttribute('data-order-id');
      const symbol = btn.getAttribute('data-symbol');
      const current = btn.getAttribute('data-current');
      document.getElementById('tpModalOrderId').value = orderId;
      document.getElementById('tpModalSymbol').textContent = `(${symbol})`;
      document.getElementById('tpModalValue').value = current && current !== '0' ? current : '';
    });
  }
  const slModal = document.getElementById('slModal');
  if (slModal) {
    slModal.addEventListener('show.bs.modal', event => {
      const btn = event.relatedTarget;
      const orderId = btn.getAttribute('data-order-id');
      const symbol = btn.getAttribute('data-symbol');
      const current = btn.getAttribute('data-current');
      const market = btn.getAttribute('data-market');
      document.getElementById('slModalOrderId').value = orderId;
      document.getElementById('slModalSymbol').textContent = `(${symbol})`;
      document.getElementById('slModalValue').value = current && current !== '0' ? current : '';
      // Switch form action based on market
      const form = slModal.querySelector('form');
      const futAction = "{% url 'trading:update_futures_tp_sl' %}";
      const spotAction = "{% url 'trading:update_spot_sl' %}";
      form.setAttribute('action', market === 'Spot' ? spotAction : futAction);
    });
  }
  const tpsModal = document.getElementById('tpsModal');
  function recalcTotalPct() {
    let total = 0;
    document.querySelectorAll('#tpRows input[name="tp_percents[]"]').forEach(inp => {
      const v = parseFloat(inp.value);
      if (!isNaN(v)) total += v;
    });
    document.getElementById('tpTotalPct').textContent = `Total: ${total}%`;
  }
  if (tpsModal) {
    // Capture template once
    const rowsCont = document.getElementById('tpRows');
    const rowTemplateHTML = rowsCont.querySelector('.tp-row').outerHTML;
    tpsModal.addEventListener('show.bs.modal', event => {
      const btn = event.relatedTarget;
      const orderId = btn.getAttribute('data-order-id');
      const symbol = btn.getAttribute('data-symbol');
      const tpsDataRaw = btn.getAttribute('data-tps');
      const tpsData = tpsDataRaw ? decodeURIComponent(tpsDataRaw) : null;
      document.getElementById('tpsModalOrderId').value = orderId;
      document.getElementById('tpsModalSymbol').textContent = `(${symbol})`;
      // reset rows
      const rows = document.getElementById('tpRows');
      rows.innerHTML = rowTemplateHTML; // one empty row
      // Prefill if existing TPs
      try {
        const arr = tpsData ? JSON.parse(tpsData) : [];
        if (arr.length > 0) {
          // first row
          let first = rows.querySelector('.tp-row');
          first.querySelector('input[name="tp_prices[]"]').value = arr[0].price ?? '';
          first.querySelector('input[name="tp_percents[]"]').value = arr[0].percent ?? '';
          if (arr[0].status && arr[0].status === 'CLOSED') {
            first.querySelectorAll('input').forEach(i => i.setAttribute('disabled', 'disabled'));
            const lastCol = first.querySelector('.col-2');
            if (lastCol) {
              lastCol.innerHTML = '<span class="badge bg-success w-100">Closed</span>';
            }
          }
          // remaining
          for (let i = 1; i < arr.length; i++) {
            const wrapper = document.createElement('div');
            wrapper.innerHTML = rowTemplateHTML;
            const node = wrapper.firstElementChild;
            const inputs = node.querySelectorAll('input');
            if (inputs.length >= 2) {
              inputs[0].value = arr[i].price ?? '';
              inputs[1].value = arr[i].percent ?? '';
            }
            if (arr[i].status && arr[i].status === 'CLOSED') {
              inputs.forEach(i => i.setAttribute('disabled', 'disabled'));
              const lastCol = node.querySelector('.col-2');
              if (lastCol) {
                lastCol.innerHTML = '<span class="badge bg-success w-100">Closed</span>';
              }
            }
            rows.appendChild(node);
          }
        }
      } catch (e) {
        // ignore parse errors
      }
      recalcTotalPct();
    });
    document.getElementById('addTpRow').addEventListener('click', () => {
      const rows = document.getElementById('tpRows');
      const wrapper = document.createElement('div');
      wrapper.innerHTML = rowTemplateHTML;
      const node = wrapper.firstElementChild;
      node.querySelectorAll('input').forEach(i => i.value = '');
      rows.appendChild(node);
    });
    document.getElementById('tpRows').addEventListener('click', (e) => {
      if (e.target && e.target.classList.contains('remove-row')) {
        const row = e.target.closest('.tp-row');
        const rows = document.querySelectorAll('#tpRows .tp-row');
        if (rows.length > 1) row.remove();
        recalcTotalPct();
      }
    });
    document.getElementById('tpRows').addEventListener('input', (e) => {
      if (e.target && e.target.name === 'tp_percents[]') recalcTotalPct();
    });
  }
  // Simple spinner on refresh submit
  document.querySelectorAll('.refresh-form').forEach(f => {
    f.addEventListener('submit', () => {
      const btn = f.querySelector('.refresh-btn');
      const icon = f.querySelector('.refresh-icon');
      if (btn && icon) {
        btn.disabled = true;
        icon.classList.remove('bi-arrow-repeat');
        icon.classList.add('spinner-border', 'spinner-border-sm');
      }
    });
  });
</script>
{% endblock %}
